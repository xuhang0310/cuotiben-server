# AI群聊项目开发规则 (Rules)

## 1. 代码规范

### 1.1 命名规范
- 变量和函数名使用 snake_case
- 类名使用 PascalCase
- 常量使用 UPPER_SNAKE_CASE
- 私有成员以单下划线开头 (_private_method)

### 1.2 代码结构
- 每个函数应有清晰的文档字符串
- 函数长度不超过50行，类不超过300行
- 遵循单一职责原则
- 使用类型提示 (Type Hints)

### 1.3 导入规范
- 标准库导入 > 第三方库导入 > 本地应用导入
- 每组导入之间空一行
- 避免使用 `from module import *`

## 2. API设计规则

### 2.1 端点设计
- 使用 RESTful 风格
- 路径使用名词复数形式 (e.g., `/groups`, `/members`)
- 使用 HTTP 方法表示操作 (GET/POST/PUT/DELETE)
- 路径层级不超过3层

### 2.2 响应格式
- 所有响应必须遵循统一格式
- 成功响应使用 2xx 状态码
- 错误响应使用相应错误状态码
- 错误信息应清晰且用户友好

### 2.3 认证与授权
- 所有需要认证的端点必须验证 JWT Token
- 实施适当的权限检查
- 不要在响应中暴露敏感信息

## 3. AI角色差异化规则

### 3.1 人格特征管理
- 人格特征必须在创建AI成员时明确定义
- 人格特征长度限制在500字符以内
- 人格特征应具体且可操作 (如"逻辑严谨"而非"聪明")

### 3.2 立场一致性
- AI必须在其回应中体现其初始立场
- 实施立场漂移检测机制
- 确保AI不会轻易改变其核心观点

### 3.3 相关性检测
- AI只应在被提及或话题相关时回应
- 实施智能触发机制，避免过度活跃
- 优先级：直接提及 > 话题相关 > 一般回应

## 4. 数据库操作规则

### 4.1 查询优化
- 使用适当的索引
- 避免 N+1 查询问题
- 使用批量操作处理大量数据

### 4.2 事务管理
- 在修改数据时使用事务
- 正确处理事务回滚
- 避免长时间持有数据库锁

### 4.3 数据验证
- 在数据库层面实施约束
- 在应用层面进行输入验证
- 防止SQL注入和其他安全漏洞

## 5. 错误处理规则

### 5.1 异常分类
- 业务逻辑错误：返回 4xx 状态码
- 系统错误：返回 5xx 状态码
- 预期错误：提供有意义的错误信息

### 5.2 错误日志
- 记录所有错误日志
- 包含足够的上下文信息
- 避免在日志中记录敏感信息

## 6. 性能规则

### 6.1 响应时间
- API响应时间应小于500ms (95th percentile)
- AI响应生成时间不应超过10秒
- 实施适当的缓存策略

### 6.2 并发处理
- 实施适当的速率限制
- 使用异步处理长时间运行的操作
- 避免阻塞主线程

### 6.3 资源管理
- 及时释放数据库连接
- 实施内存使用监控
- 避免内存泄漏

## 7. 测试规则

### 7.1 测试覆盖率
- 单元测试覆盖率不低于80%
- 集成测试覆盖主要业务流程
- 实施自动化测试

### 7.2 测试类型
- 单元测试：测试独立函数和类
- 集成测试：测试API端点和数据库交互
- 端到端测试：测试完整用户流程

## 8. 安全规则

### 8.1 输入验证
- 所有用户输入必须验证
- 防止XSS和CSRF攻击
- 实施适当的输出编码

### 8.2 数据保护
- 加密存储敏感信息
- 实施访问控制
- 定期审查权限设置

## 9. AI模型集成规则

### 9.1 API调用
- 实施重试机制
- 处理API限流
- 监控API调用成本

### 9.2 响应处理
- 验证AI响应的适当性
- 实施内容过滤机制
- 处理AI服务不可用情况

## 10. 部署与运维规则

### 10.1 环境管理
- 使用环境变量管理配置
- 实施配置版本控制
- 区分开发、测试、生产环境

### 10.2 监控与告警
- 监控API性能指标
- 设置错误率告警
- 实施健康检查端点

## 11. 文档规则

### 11.1 代码文档
- 所有公共API必须有文档字符串
- 复杂逻辑需要注释说明
- 更新文档与代码同步

### 11.2 API文档
- 使用Swagger/OpenAPI规范
- 保持文档与实现同步
- 提供使用示例

## 12. 团队协作规则

### 12.1 Git工作流
- 使用Git Flow或类似分支策略
- 提交信息遵循约定格式
- 代码审查必需

### 12.2 代码审查
- 检查代码规范遵守情况
- 验证功能实现正确性
- 确认安全性考虑